<!-- testTemplate.html MIT --><!-- BUILT: 2023/4/24 11:38:45 --><!-- Konva JavaScript Framework v8.3.14 --><!-- http://konvajs.org/ --><!-- Licensed under the MIT --><!-- Date: Wed Nov 09 2022 --><!-- Original work Copyright (C) 2011 - 2013 by Eric Rowell (KineticJS) --><!-- Modified work Copyright (C) 2014 - present by Anton Lavrenov (Konva) --><!-- @license --><!--lottie-player v1.6.0--><!--https://lottiefiles.com/--><!-- Licensed under the MIT --><!--Copyright (c) 2019 LottieFiles.com--><!-- @license --><!doctype html><html lang=en><head><meta charset=UTF-8><title>testTemplate</title></head><body><style>.popup{font-family:Arial,sans-serif;position:fixed;top:0;left:0;width:100%;height:100%;z-index:100;display:flex;overflow:hidden;justify-content:center;align-items:center}.popup_body{background:antiquewhite;border-radius:10px;min-width:840px}.popup_background{display:flex;flex-direction:column;justify-content:center;align-items:center;flex:1;position:relative}.popup_content{background:rgba(255,255,255,.7);position:absolute;top:0;bottom:0;left:0;right:0;display:flex;padding:0 224px;flex-direction:column;justify-content:center;align-items:center}.popup_title{font-weight:800;font-size:48px;margin:0 0 6px 0;line-height:71px;text-align:center;text-transform:uppercase;color:#251d4d}.popup_subtitle{font-style:normal;font-weight:400;font-size:24px;line-height:32px;text-align:center;text-transform:uppercase;color:#251d4d}.popup_close_button{position:absolute;top:0;right:0;width:20px;height:20px;display:flex;justify-content:center;align-items:center;cursor:pointer;margin-top:20px;margin-right:20px}.popup_hide{display:none}</style><script src=https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js></script><div class="popup popup_hide" id=popup><div class=popup_body><div class=popup_background><lottie-player autoplay background=transparent loop speed=1 src=https://assets5.lottiefiles.com/packages/lf20_qsepfuxs.json style=width:840px;height:540px></lottie-player><div class=popup_content><div class=popup_close_button id=popup_close_button><svg viewbox="0 0 36 36" fill=none height=36 width=36 xmlns=http://www.w3.org/2000/svg><rect transform="matrix(0.707815 -0.706397 0.707815 0.706397 0 7.18555)" fill=#C7C7C7 height=40.6883 rx=5.08604 width=10.1721 /><rect transform="matrix(-0.707815 -0.706397 0.707815 -0.706397 7.2002 36)" fill=#C7C7C7 height=40.6883 rx=5.08604 width=10.1721 /></svg></div><div><h2 class=popup_title>Congrats!</h2><span class=popup_subtitle>Your solution is correct</span></div></div></div></div></div><script>const closePopup=()=>{const a=document.getElementById('popup');a.classList.add('popup_hide')};const popupCloseButton=document.getElementById('popup_close_button');popupCloseButton.addEventListener('click',closePopup);const body=document.querySelector('body');body.addEventListener('click',a=>{const b=document.getElementById('popup');if(a.target===b){closePopup()}})</script><div id=konva_interactive_container></div><script src=https://unpkg.com/konva@8/konva.min.js></script><script>const interactivePictureStr='{\"identifier\":{\"name\":\"My interactive picture\",\"code\":\"my_interactive_picture\",\"id\":null,\"nameEditedManually\":null,\"codeEditedManually\":null},\"background\":{\"picture\":null,\"width\":870,\"height\":489},\"style\":{\"defaultText\":null,\"background\":null,\"frame\":null,\"staticFigure\":null,\"staticLine\":null,\"button\":null,\"selector\":null,\"inputGeometry\":null,\"inputText\":null,\"drag\":null,\"hint\":null,\"hintText\":null,\"checkButton\":null,\"checkButtonText\":null,\"restartButton\":null,\"restartButtonText\":null},\"designCode\":null,\"frames\":[],\"figuresAndLines\":[{\"type\":\"Figure\",\"identifier\":{\"name\":\"TextStatic\",\"code\":\"textstatic__16823362084421561844065\",\"id\":\"TextStatic_16823362084401742896686\",\"nameEditedManually\":null,\"codeEditedManually\":null},\"visibleElement\":{\"type\":\"TextStatic\",\"identifier\":{\"name\":\"TextStatic_VisibleElement\",\"code\":\"textstatic_visibleelement__1682336208443199741299\",\"id\":\"TextStatic_16823362084401742896686_VisibleElement\",\"nameEditedManually\":null,\"codeEditedManually\":null},\"showCondition\":{\"solvingStageCondition\":{\"activeBeforeSolvingStart\":\"1\",\"activeWhileSolving\":\"1\",\"activeAfterFirstVerification\":\"1\",\"activeAfterFinalVerification\":\"1\"}},\"geometry\":{\"rect\":{\"type\":\"Rect\",\"leftTopPosition\":{\"absolutePosition\":{\"x\":385,\"y\":224},\"relativeToMousePosition\":null,\"otherElementAnchorPoint\":null},\"width\":100,\"height\":40},\"circle\":null,\"curve\":null,\"polyBlobLine\":null},\"text\":{\"simpleText\":null,\"style\":{\"fontFamily\":\"Arial\",\"fontSize\":14,\"fontStyle\":\"700\",\"textColor\":\"#FDFDFD\",\"padding\":0,\"align\":\"center\",\"verticalAlign\":\"middle\"},\"type\":\"EditHtmlRenderSvg\",\"htmlEditView\":null,\"renderView\":null},\"picture\":null,\"style\":{\"usual\":{\"cornerRadius\":5,\"strokeColor\":null,\"strokeWidth\":2,\"lineCap\":null,\"lineJoin\":null,\"dash\":null,\"fillColor\":\"#1C274C\",\"opacity\":1.0,\"shadowColor\":null,\"shadowBlur\":null,\"shadowOffset\":null,\"shadowOpacity\":null,\"mouseCursor\":null},\"onHover\":{\"cornerRadius\":5,\"strokeColor\":\"#4096ff\",\"strokeWidth\":2,\"lineCap\":null,\"lineJoin\":null,\"dash\":null,\"fillColor\":\"#1C274C\",\"opacity\":1.0,\"shadowColor\":null,\"shadowBlur\":null,\"shadowOffset\":null,\"shadowOpacity\":null,\"mouseCursor\":\"pointer\"},\"onFocus\":{\"cornerRadius\":5,\"strokeColor\":\"#4096ff\",\"strokeWidth\":2,\"lineCap\":null,\"lineJoin\":null,\"dash\":null,\"fillColor\":\"#1C274C\",\"opacity\":1.0,\"shadowColor\":null,\"shadowBlur\":null,\"shadowOffset\":null,\"shadowOpacity\":null,\"mouseCursor\":null},\"onSelect\":{\"cornerRadius\":null,\"strokeColor\":null,\"strokeWidth\":null,\"lineCap\":null,\"lineJoin\":null,\"dash\":null,\"fillColor\":\"#F7F7F7\",\"opacity\":1.0,\"shadowColor\":null,\"shadowBlur\":null,\"shadowOffset\":null,\"shadowOpacity\":null,\"mouseCursor\":null},\"onDrag\":null,\"correctSelected\":null,\"wrongSelected\":null,\"correctUnselected\":null,\"wrongUnselected\":null}},\"hint\":{\"type\":\"TextStatic\",\"identifier\":{\"name\":\"TextStatic_Hint\",\"code\":\"textstatic_hint__16823362084431475769363\",\"id\":\"TextStatic_16823362084401742896686_Hint\",\"nameEditedManually\":null,\"codeEditedManually\":null},\"showCondition\":{\"solvingStageCondition\":{\"activeBeforeSolvingStart\":\"1\",\"activeWhileSolving\":\"1\",\"activeAfterFirstVerification\":\"1\",\"activeAfterFinalVerification\":\"1\"}},\"geometry\":{\"rect\":null,\"circle\":null,\"curve\":null,\"polyBlobLine\":null},\"text\":{\"simpleText\":\"\",\"style\":{\"fontFamily\":\"Calibri\",\"fontSize\":15,\"fontStyle\":null,\"textColor\":\"white\",\"padding\":10,\"align\":\"center\",\"verticalAlign\":\"middle\"},\"type\":\"EditHtmlRenderSvg\",\"htmlEditView\":null,\"renderView\":null},\"picture\":null,\"style\":{\"usual\":{\"cornerRadius\":5,\"strokeColor\":null,\"strokeWidth\":null,\"lineCap\":null,\"lineJoin\":null,\"dash\":null,\"fillColor\":\"#5e6472\",\"opacity\":0.7,\"shadowColor\":null,\"shadowBlur\":null,\"shadowOffset\":null,\"shadowOpacity\":null,\"mouseCursor\":null},\"onHover\":{\"cornerRadius\":5,\"strokeColor\":null,\"strokeWidth\":null,\"lineCap\":null,\"lineJoin\":null,\"dash\":null,\"fillColor\":\"#5e6472\",\"opacity\":0.7,\"shadowColor\":null,\"shadowBlur\":null,\"shadowOffset\":null,\"shadowOpacity\":null,\"mouseCursor\":null},\"onFocus\":{\"cornerRadius\":5,\"strokeColor\":null,\"strokeWidth\":null,\"lineCap\":null,\"lineJoin\":null,\"dash\":null,\"fillColor\":\"#5e6472\",\"opacity\":0.7,\"shadowColor\":null,\"shadowBlur\":null,\"shadowOffset\":null,\"shadowOpacity\":null,\"mouseCursor\":null},\"onSelect\":{\"cornerRadius\":5,\"strokeColor\":null,\"strokeWidth\":null,\"lineCap\":null,\"lineJoin\":null,\"dash\":null,\"fillColor\":\"#5e6472\",\"opacity\":0.7,\"shadowColor\":null,\"shadowBlur\":null,\"shadowOffset\":null,\"shadowOpacity\":null,\"mouseCursor\":null},\"onDrag\":null,\"correctSelected\":null,\"wrongSelected\":null,\"correctUnselected\":null,\"wrongUnselected\":null}},\"gapPuzzle\":null,\"input\":null,\"button\":null,\"selector\":null},{\"type\":\"Figure\",\"identifier\":{\"name\":\"MarkerStatic\",\"code\":\"markerstatic__1682336208969-852190088\",\"id\":\"MarkerStatic_1682336208969973911831\",\"nameEditedManually\":null,\"codeEditedManually\":null},\"visibleElement\":{\"type\":\"MarkerStatic\",\"identifier\":{\"name\":\"MarkerStatic_VisibleElement\",\"code\":\"markerstatic_visibleelement__16823362089701688544008\",\"id\":\"MarkerStatic_1682336208969973911831_VisibleElement\",\"nameEditedManually\":null,\"codeEditedManually\":null},\"showCondition\":{\"solvingStageCondition\":{\"activeBeforeSolvingStart\":\"1\",\"activeWhileSolving\":\"1\",\"activeAfterFirstVerification\":\"1\",\"activeAfterFinalVerification\":\"1\"}},\"geometry\":{\"rect\":null,\"circle\":{\"type\":\"Circle\",\"centerPosition\":{\"absolutePosition\":{\"x\":226,\"y\":224},\"relativeToMousePosition\":null,\"otherElementAnchorPoint\":null},\"radius\":50},\"curve\":null,\"polyBlobLine\":null},\"text\":{\"simpleText\":null,\"style\":{\"fontFamily\":\"Arial\",\"fontSize\":20,\"fontStyle\":\"700\",\"textColor\":\"#1C274C\",\"padding\":0,\"align\":\"center\",\"verticalAlign\":\"middle\"},\"type\":\"EditHtmlRenderSvg\",\"htmlEditView\":null,\"renderView\":null},\"picture\":null,\"style\":{\"usual\":{\"cornerRadius\":5,\"strokeColor\":null,\"strokeWidth\":0,\"lineCap\":null,\"lineJoin\":null,\"dash\":null,\"fillColor\":\"#FEAC66\",\"opacity\":1.0,\"shadowColor\":null,\"shadowBlur\":null,\"shadowOffset\":null,\"shadowOpacity\":null,\"mouseCursor\":null},\"onHover\":{\"cornerRadius\":5,\"strokeColor\":\"#4096ff\",\"strokeWidth\":2,\"lineCap\":null,\"lineJoin\":null,\"dash\":null,\"fillColor\":\"#FEAC66\",\"opacity\":1.0,\"shadowColor\":null,\"shadowBlur\":null,\"shadowOffset\":null,\"shadowOpacity\":null,\"mouseCursor\":\"pointer\"},\"onFocus\":{\"cornerRadius\":5,\"strokeColor\":\"#4096ff\",\"strokeWidth\":2,\"lineCap\":null,\"lineJoin\":null,\"dash\":null,\"fillColor\":\"#FEAC66\",\"opacity\":1.0,\"shadowColor\":null,\"shadowBlur\":null,\"shadowOffset\":null,\"shadowOpacity\":null,\"mouseCursor\":null},\"onSelect\":{\"cornerRadius\":null,\"strokeColor\":null,\"strokeWidth\":null,\"lineCap\":null,\"lineJoin\":null,\"dash\":null,\"fillColor\":\"#F7F7F7\",\"opacity\":1.0,\"shadowColor\":null,\"shadowBlur\":null,\"shadowOffset\":null,\"shadowOpacity\":null,\"mouseCursor\":null},\"onDrag\":null,\"correctSelected\":null,\"wrongSelected\":null,\"correctUnselected\":null,\"wrongUnselected\":null}},\"hint\":{\"type\":\"MarkerStatic\",\"identifier\":{\"name\":\"MarkerStatic_Hint\",\"code\":\"markerstatic_hint__1682336208970-1481743340\",\"id\":\"MarkerStatic_1682336208969973911831_Hint\",\"nameEditedManually\":null,\"codeEditedManually\":null},\"showCondition\":{\"solvingStageCondition\":{\"activeBeforeSolvingStart\":\"1\",\"activeWhileSolving\":\"1\",\"activeAfterFirstVerification\":\"1\",\"activeAfterFinalVerification\":\"1\"}},\"geometry\":{\"rect\":null,\"circle\":null,\"curve\":null,\"polyBlobLine\":null},\"text\":{\"simpleText\":\"\",\"style\":{\"fontFamily\":\"Calibri\",\"fontSize\":15,\"fontStyle\":null,\"textColor\":\"white\",\"padding\":10,\"align\":\"center\",\"verticalAlign\":\"middle\"},\"type\":\"EditHtmlRenderSvg\",\"htmlEditView\":null,\"renderView\":null},\"picture\":null,\"style\":{\"usual\":{\"cornerRadius\":5,\"strokeColor\":null,\"strokeWidth\":null,\"lineCap\":null,\"lineJoin\":null,\"dash\":null,\"fillColor\":\"#5e6472\",\"opacity\":0.7,\"shadowColor\":null,\"shadowBlur\":null,\"shadowOffset\":null,\"shadowOpacity\":null,\"mouseCursor\":null},\"onHover\":{\"cornerRadius\":5,\"strokeColor\":null,\"strokeWidth\":null,\"lineCap\":null,\"lineJoin\":null,\"dash\":null,\"fillColor\":\"#5e6472\",\"opacity\":0.7,\"shadowColor\":null,\"shadowBlur\":null,\"shadowOffset\":null,\"shadowOpacity\":null,\"mouseCursor\":null},\"onFocus\":{\"cornerRadius\":5,\"strokeColor\":null,\"strokeWidth\":null,\"lineCap\":null,\"lineJoin\":null,\"dash\":null,\"fillColor\":\"#5e6472\",\"opacity\":0.7,\"shadowColor\":null,\"shadowBlur\":null,\"shadowOffset\":null,\"shadowOpacity\":null,\"mouseCursor\":null},\"onSelect\":{\"cornerRadius\":5,\"strokeColor\":null,\"strokeWidth\":null,\"lineCap\":null,\"lineJoin\":null,\"dash\":null,\"fillColor\":\"#5e6472\",\"opacity\":0.7,\"shadowColor\":null,\"shadowBlur\":null,\"shadowOffset\":null,\"shadowOpacity\":null,\"mouseCursor\":null},\"onDrag\":null,\"correctSelected\":null,\"wrongSelected\":null,\"correctUnselected\":null,\"wrongUnselected\":null}},\"gapPuzzle\":null,\"input\":null,\"button\":null,\"selector\":null}],\"controls\":[],\"gapPuzzles\":[],\"checkPatternType\":\"CheckButton\",\"hasRestartButton\":\"1\",\"requestParams\":{\"debug\":null,\"generateHtmlInReadableFormat\":null,\"includeHtmlHeader\":\"1\",\"includeLibrariesCodeToWorkOffline\":null}}'.replaceAll(/&quot;/g,'"');const interactivePicture=JSON.parse(interactivePictureStr);console.log(interactivePicture);const defaultKonvaStyles={usual:{cornerRadius:0,strokeColor:"",strokeWidth:0,lineCap:"butt",lineJoin:"miter",dash:[],fillColor:"",opacity:1,shadowColor:"",shadowBlur:0,shadowOffset:{x:0,y:0},shadowOpacity:1},onHover:{mouseCursor:"default",cornerRadius:0,strokeColor:"",strokeWidth:0,lineCap:"butt",lineJoin:"miter",dash:[],fillColor:"",opacity:1,shadowColor:"",shadowBlur:0,shadowOffset:{x:0,y:0},shadowOpacity:1},onFocus:{mouseCursor:"default",cornerRadius:0,strokeColor:"",strokeWidth:0,lineCap:"butt",lineJoin:"miter",dash:[],fillColor:"",opacity:1,shadowColor:"",shadowBlur:0,shadowOffset:{x:0,y:0},shadowOpacity:1},onSelect:{mouseCursor:"default",cornerRadius:0,strokeColor:"",strokeWidth:0,lineCap:"butt",lineJoin:"miter",dash:[],fillColor:"",opacity:1,shadowColor:"",shadowBlur:0,shadowOffset:{x:0,y:0},shadowOpacity:1},onDrag:{mouseCursor:"default",cornerRadius:0,strokeColor:"",strokeWidth:0,lineCap:"butt",lineJoin:"miter",dash:[],fillColor:"",opacity:1,shadowColor:"",shadowBlur:0,shadowOffset:{x:0,y:0},shadowOpacity:1},correctSelected:{mouseCursor:"default",cornerRadius:5,strokeColor:"#4BB96D",strokeWidth:1,lineCap:"butt",lineJoin:"miter",dash:[],fillColor:"#4BB96D",opacity:1,shadowColor:"",shadowBlur:0,shadowOffset:{x:0,y:0},shadowOpacity:1},wrongSelected:{mouseCursor:"default",cornerRadius:5,strokeColor:"#F16F63",strokeWidth:1,lineCap:"butt",lineJoin:"miter",dash:[],fillColor:"#F16F63",opacity:1,shadowColor:"",shadowBlur:0,shadowOffset:{x:0,y:0},shadowOpacity:1},correctUnselected:{mouseCursor:"default",cornerRadius:0,strokeColor:"",strokeWidth:0,lineCap:"butt",lineJoin:"miter",dash:[],fillColor:"",opacity:1,shadowColor:"",shadowBlur:0,shadowOffset:{x:0,y:0},shadowOpacity:1},wrongUnselected:{mouseCursor:"default",cornerRadius:0,strokeColor:"",strokeWidth:0,lineCap:"butt",lineJoin:"miter",dash:[],fillColor:"",opacity:1,shadowColor:"",shadowBlur:0,shadowOffset:{x:0,y:0},shadowOpacity:1},textFrame:{fontFamily:"Arial",fontSize:14,fontStyle:"700",textColor:"#FDFDFD",padding:0,align:"center",verticalAlign:"middle"}};const logging={};logging.queryString=window.location.search;logging.urlParams=new URLSearchParams(logging.queryString);logging.platformCode=logging.urlParams.get('platformCode');logging.userId=logging.urlParams.get('userId');logging.lessonId=logging.urlParams.get('lessonId');logging.interactiveData=logging.urlParams.get('interactiveData');logging.interactiveName=interactivePicture.identifier.name;logging.interactiveCode=interactivePicture.identifier.code;logging.interactiveFileName=`${interactivePicture.identifier.code}.html`;logging.userAgent=navigator.userAgent;logging.isMobile=false;if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substring(0,4))){logging.isMobile=true};logging.localTime=new Date().toString();logging.timeZone=Intl.DateTimeFormat().resolvedOptions().timeZone;const scaleParams={resultDivOriginalScaleX:1.0,resultDivOriginalScaleY:1.0,resultMinusOriginalScaledShiftX:0.0,resultMinusOriginalScaledShiftY:0.0};const windowParams={windowWidth:window.innerWidth,windowHeight:window.innerHeight,backgroundImageWidth:window.innerWidth*0.9,backgroundImageHeight:window.innerHeight*0.7,widthPadding:window.innerWidth*0.02,heightPadding:window.innerHeight*0.02,backgroundStartX:null,backgroundEndX:null,currentFreeSpaceX:null,currentFreeSpaceY:null,newLineSpaceY:0};const solvingParams={allSolvingElements:0,currentSolved:0};function scaleToResultX(a){return a*scaleParams.resultDivOriginalScaleX}function scaleToResultY(a){return a*scaleParams.resultDivOriginalScaleY}function transformToResultX(a){return scaleToResultX(a)+ scaleParams.resultMinusOriginalScaledShiftX}function transformToResultY(a){return scaleToResultY(a)+ scaleParams.resultMinusOriginalScaledShiftY}function placeNewObjectToBottomLeft(a,b){if(windowParams.currentFreeSpaceX+ a>windowParams.backgroundEndX){windowParams.currentFreeSpaceY=windowParams.newLineSpaceY;var c=windowParams.backgroundStartX;var d=windowParams.currentFreeSpaceY;windowParams.currentFreeSpaceX=c+ a+ windowParams.widthPadding;windowParams.newLineSpaceY=d+ b+ windowParams.heightPadding;return [c,d]}else{var c=windowParams.currentFreeSpaceX;var d=windowParams.currentFreeSpaceY;windowParams.currentFreeSpaceX=c+ a+ windowParams.widthPadding;windowParams.newLineSpaceY=Math.max(windowParams.newLineSpaceY,d+ b+ windowParams.heightPadding);return [c,d]}}function placeNewObjectToBottomCenterNewLine(a,b){windowParams.currentFreeSpaceY=windowParams.newLineSpaceY;var c=(windowParams.windowWidth- a)*0.5;var d=windowParams.currentFreeSpaceY;windowParams.currentFreeSpaceX=0;windowParams.newLineSpaceY=d+ b+ windowParams.heightPadding;return [c,d]}const getGeometry=a=>{const {geometry:b}=a.visibleElement;for(const c in b){if(b[c]){return b[c]}}};function checkStageCondition(a){const b=a&&a.solvingStageCondition?a.solvingStageCondition:{activeBeforeSolvingStart:"1",activeWhileSolving:"1",activeAfterFirstVerification:"1"};if(solvingState===SolvingState.BEFORE_SOLVING_START&&b.activeBeforeSolvingStart||solvingState===SolvingState.WHILE_SOLVING&&b.activeWhileSolving||solvingState===SolvingState.AFTER_FIRST_VERIFICATION&&b.activeAfterFirstVerification||solvingState===SolvingState.AFTER_FINAL_VERIFICATION&&b.activeAfterFinalVerification){return true};return false}function handleShowCondition(a,b){if(checkStageCondition(a)){b.moveToTop();b.show();return true}else{b.hide();return false}}function getStyles(a,b,c){const d={};for(const e in c){if(c[e]){d[e]={};for(const f in c[e]){if(a&&a[e]&&a[e][f]){d[e][f]=a[e][f]}else if(b&&b[e]&&b[e][f]){d[e][f]=b[e][f]}else{d[e][f]=c[e][f]}}}};return d}function getTextFrameStyles(a,b){const c=defaultKonvaStyles.textFrame;const d={};for(const e in c){if(a&&a[e]!==undefined){d[e]=a[e]}else if(b&&b[e]){d[e]=b[e]}else{d[e]=c[e]}};return d}function setStyleOnEvent(a,b,c){a.fill(c.fillColor);a.stroke(c.strokeColor);a.strokeWidth(c.strokeWidth);a.opacity(c.opacity);a.shadowColor(c.shadowColor);a.shadowOffset(c.shadowOffset);a.shadowBlur(c.shadowBlur);a.shadowOpacity(c.shadowOpacity);a.dash(c.dash);if(b==='Rect'){a.cornerRadius(c.cornerRadius)};if(b==='Curve'){a.stroke(c.fillColor);;}}function setStyleOnCheckedElement(a,b,c,d){a.on('mouseover mouseout mouseenter mouseleave mousemove',()=>setStyleOnEvent(b,"Rect",d))}function checkGapPuzzle(a,b){const c=a.gapPuzzle.absolutePosition();const d={x:c.x+ a.rect.width()/2,y:c.y+ a.rect.height()/2};const e=transformToResultX(b.gapPuzzle.gap.geometry.rect.leftTopPosition.absolutePosition.x);const f=transformToResultY(b.gapPuzzle.gap.geometry.rect.leftTopPosition.absolutePosition.y);const g=transformToResultX(b.gapPuzzle.gap.geometry.rect.leftTopPosition.absolutePosition.x+ b.gapPuzzle.gap.geometry.rect.width);const h=transformToResultY(b.gapPuzzle.gap.geometry.rect.leftTopPosition.absolutePosition.y+ b.gapPuzzle.gap.geometry.rect.height);return e<=d.x&&d.x<=g&&f<=d.y&&d.y<=h}function checkButton(a,b){console.log("button:",a);console.log(b)}function checkSelector(a,b){console.log("selector:",a);console.log(b)}const ECorrectState=Object.freeze({Correct:"correct",Incorrect:"incorrect"});function createKonvaText(a,b,c){const d=getTextFrameStyles(b.style,c);const e=new Konva.Text({text:b.simpleText,fontFamily:d.fontFamily,fontSize:scaleToResultX(d.fontSize),fontStyle:d.fontStyle,padding:scaleToResultX(d.padding),fill:d.textColor,align:d.align,verticalAlign:d.verticalAlign});e.width(a.width());e.height(a.height());return e}function createKonvaRect(a,b){const c=getStyles(a.style,b,defaultKonvaStyles);const {width:d,height:e}=a.geometry.rect;const f=new Konva.Rect({width:scaleToResultX(d),height:scaleToResultY(e),fill:c.usual.fillColor,cornerRadius:c.usual.cornerRadius,stroke:c.usual.strokeColor,strokeWidth:c.usual.strokeWidth,opacity:c.usual.opacity,shadowColor:c.usual.shadowColor,shadowOffset:c.usual.shadowOffset,shadowBlur:0,shadowOpacity:c.usual.shadowOpacity,dash:c.usual.dash});if(c.usual.shadowBlur!==0){f.filters([Konva.Filters.Blur]);f.blurRadius(c.usual.shadowBlur)};return f}function createKonvaBluredBGCut(a,b,c,d,e,f){const g=new Image();g.src=c;const h=new Image();const i=a.cornerRadius();g.onload=function(){const j=document.createElement('canvas');j.width=g.width;j.height=g.height;const k=b.x;const l=b.y;const m=a.width();const n=a.height();const o=j.getContext('2d');o.filter="blur("+ f+ "px)";clipContext(o,m- 2,n- 2,k+ 1,l+ 1,i);o.drawImage(g,0,0,j.width,j.height);const p=j.toDataURL();h.src=p};h.onload=function(){const j=e?b.x:0;const k=e?b.y:0;const l=new Konva.Image({image:h,x:j,y:k});l.crop({x:b.x,y:b.y,width:a.width(),height:a.height()});l.width(a.width());l.height(a.height());d.add(l)};return g}function clipContext(a,b,c,d,e,f){a.beginPath();a.moveTo(d+ f,e);a.lineTo(d+ b- f,e);a.quadraticCurveTo(d+ b,e,d+ b,e+ f);a.lineTo(d+ b,e+ c- f);a.quadraticCurveTo(d+ b,e+ c,d+ b- f,e+ c);a.lineTo(d+ f,e+ c);a.quadraticCurveTo(d,e+ c,d,e+ c- f);a.lineTo(d,e+ f);a.quadraticCurveTo(d,e,d+ f,e);a.closePath();a.clip()}function createKonvaCircle(a,b){const c=getStyles(a.visibleElement.style,b,defaultKonvaStyles);const d=scaleToResultX(a.visibleElement.geometry.circle.radius);return new Konva.Circle({x:d,y:d,radius:d,fill:c.usual.fillColor,stroke:c.usual.strokeColor,strokeWidth:c.usual.strokeWidth,opacity:c.usual.opacity,shadowColor:c.usual.shadowColor,shadowOffset:c.usual.shadowOffset,shadowBlur:c.usual.shadowBlur,shadowOpacity:c.usual.shadowOpacity,dash:c.usual.dash})}function createKonvaPicture(a,b,c){const d=new Image();d.src=b.base64;d.onload=function(){const e=new Konva.Image({width:a.width(),height:a.height(),image:d});c.add(e)}}function getPoints(a){const b=[];if(a.start.absolutePosition){b.push(transformToResultX(a.start.absolutePosition.x),transformToResultY(a.start.absolutePosition.y))};if(a.middle){b.push(transformToResultX(a.middle.absolutePosition.x),transformToResultY(a.middle.absolutePosition.y))};if(a.end.absolutePosition){b.push(transformToResultX(a.end.absolutePosition.x),transformToResultY(a.end.absolutePosition.y))};console.log();return b}function createKonvaCurve(a){const b=getStyles(a.visibleElement.style,interactivePicture.style.staticLine,defaultKonvaStyles);const c=a.visibleElement.geometry.curve.type;let d;const e=a.visibleElement.geometry.curve.startType;const f=a.visibleElement.geometry.curve.endType;if(e||f){d=new Konva.Arrow({points:getPoints(a.visibleElement.geometry.curve),stroke:b.usual.fillColor,strokeWidth:b.usual.strokeWidth,lineCap:b.usual.lineCap,lineJoin:b.usual.lineJoin,dash:b.usual.dash,tension:0.5,fill:b.usual.fillColor,pointerLength:scaleToResultX(8),pointerWidth:scaleToResultX(7),pointerAtBeginning:Boolean(e),pointerAtEnding:Boolean(f)})}else{d=new Konva.Line({points:getPoints(a.visibleElement.geometry.curve),stroke:b.usual.fillColor,strokeWidth:b.usual.strokeWidth,lineCap:b.usual.lineCap,lineJoin:b.usual.lineJoin,dash:b.usual.dash,tension:0.5})};d.on('mouseover',g=>setStyleOnEvent(g.target,c,b.onHover));d.on('mouseout',g=>setStyleOnEvent(g.target,c,b.usual));d.on('dragstart dragmove',g=>setStyleOnEvent(g.target,c,b.onDrag));d.on('dragend',g=>setStyleOnEvent(g.target,c,b.usual));d.on('click tap pointerclick',g=>setStyleOnEvent(g.target,c,b.onFocus));document.addEventListener("solving-state",()=>{handleShowCondition(a.visibleElement.showCondition,d)});return d}function createSelectorKonvaElements(a,b,c){const d=new Konva.Group({width:b.width});const e=new Konva.Group({width:b.width,x:transformToResultX(a.visibleElement.geometry.rect.leftTopPosition.absolutePosition.x),y:b.currentY});const f=createKonvaRect(a.visibleElement,interactivePicture.style.selector);const g=createKonvaText(f,a.visibleElement.text,{align:"left",fontSize:14,fontFamily:'Arial',padding:15,textColor:'black'});e.add(f);e.add(g);b.currentY+=f.height()+ 1;const h=new Konva.Group({width:b.width,visible:false});const i=new Konva.Rect({width:d.width(),stroke:c.usual.strokeColor,strokeWidth:c.usual.strokeWidth,cornerRadius:c.usual.cornerRadius,fill:c.usual.fillColor,x:e.getX(),y:b.currentY});const j=new Konva.RegularPolygon({sides:3,radius:g.height()/6,x:f.getX()+ f.width()- g.height()/2,y:g.getY()+ g.height()/2,fill:'black',rotation:180});if(a.hint.geometry&&a.hint.text.simpleText){addHint(a.hint,e)};e.add(j);d.add(e);h.add(i);return {selector:d,mainGroup:e,mainText:g,mainRect:f,optionsGroup:h,optionsRect:i,triangle:j}}function addSelectorEvents(a,b,c,d){document.addEventListener("solving-state",()=>{handleShowCondition(b.visibleElement.showCondition,a.selector)});a.selector.on('mouseenter',()=>window.document.body.style.cursor="pointer");a.selector.on('mouseleave',()=>window.document.body.style.cursor="default");const e=()=>{if(checkStageCondition(b.visibleElement.showCondition)&&d.correctState.hasCorrect){if(d.correctState.correct===d.correctState.current){setStyleOnEvent(a.mainRect,"Rect",c.correctSelected);if(d.state!==ECorrectState.Correct){solvingParams.currentSolved++};d.state=ECorrectState.Correct}else{if(d.state===ECorrectState.Correct){solvingParams.currentSolved--};setStyleOnEvent(a.mainRect,"Rect",c.wrongSelected);d.state=ECorrectState.Incorrect}}};document.addEventListener("check-solving",e);const f=()=>{if(solvingState===SolvingState.BEFORE_SOLVING_START){solvingState=SolvingState.WHILE_SOLVING;document.dispatchEvent(new CustomEvent('solving-state'))};if(a.optionsGroup.isVisible()){a.optionsGroup.hide()}else{a.selector.moveToTop();a.optionsGroup.show()}};a.mainGroup.on('click tap',f);const g=l=>{const m=l.clientX+ window.scrollX<a.optionsRect.getX()||l.clientX+ window.scrollX>a.optionsRect.getX()+ a.optionsRect.width();const n=l.clientY+ window.scrollY<a.mainRect.getY()||l.clientY+ window.scrollY>a.optionsRect.getY()+ a.optionsRect.height();if(a.optionsGroup.isVisible()&&(m||n)){a.optionsGroup.hide()}};document.addEventListener('click',g);const h=l=>{if(l.changedTouches&&l.changedTouches[0]){const m=l.changedTouches[0].clientX+ window.scrollX<a.optionsRect.getX()||l.changedTouches[0].clientX+ window.scrollX>a.optionsRect.getX()+ a.optionsRect.width();const n=l.changedTouches[0].clientY+ window.scrollY<a.mainRect.getY()||l.changedTouches[0].clientY+ window.scrollY>a.optionsRect.getY()+ a.optionsRect.height();if(a.optionsGroup.isVisible()&&(m||n)){a.optionsGroup.hide()}}};document.addEventListener('touchend',h);const i=()=>{if(d.state===ECorrectState.Correct){setStyleOnEvent(a.mainRect,"Rect",c.correctSelected)}else if(d.state===ECorrectState.Incorrect){setStyleOnEvent(a.mainRect,"Rect",c.wrongSelected)}else{setStyleOnEvent(a.mainRect,"Rect",c.onHover)}};const j=()=>{if(d.state===ECorrectState.Correct){setStyleOnEvent(a.mainRect,"Rect",c.correctSelected)}else if(d.state===ECorrectState.Incorrect){setStyleOnEvent(a.mainRect,"Rect",c.wrongSelected)}else{setStyleOnEvent(a.mainRect,"Rect",c.usual)}};const k=()=>{if(d.currentOptionElements&&checkStageCondition(b.visibleElement.showCondition)){d.currentOptionElements.forEach(l=>{l.moveToTop();l.show()})}};document.addEventListener('solving-state',k);a.mainGroup.on('mousemove touchstart',i);a.mainGroup.on('mouseout touchend',j)}function addSelectorOption(a,b,c){const d=new Konva.Rect({width:b.width,height:c.mainRect.height()});const e=createKonvaText(d,a.text,{align:"left",fontSize:14,fontFamily:'Arial',padding:15,textColor:'black'});const f=new Konva.Group({width:b.width,height:e.height(),x:c.mainGroup.getX(),y:b.currentY});const g=[];if(a.figuresAndLines){a.figuresAndLines.forEach(j=>{let k;switch(j.type){case "OptionFigure":k=addFigure(j,interactiveLayer);break;case "OptionConnection":k=addCurve(j);break};if(k){k.hide();g.push(k)}})};if(a.frames){a.frames.forEach(j=>{const k=addFigure(j,interactiveLayer);g.push(k);k.hide()})};const h=()=>{c.mainText.text(e.text());c.optionsGroup.hide();if(b.correctState.hasCorrect){b.correctState.current=f};if(b.currentOptionElements!==undefined){b.currentOptionElements.forEach(j=>{j.hide()})};b.currentOptionElements=g;g.forEach(j=>{j.moveToTop();j.show()})};f.on('click',h);const i=()=>{if(g){g.forEach(j=>{j.hide()})}};document.addEventListener('solving-state',i);if(b.correctState.hasCorrect&&a.isCorrect==="1"){b.correctState.correct=f};f.add(e);f.add(d);f.on('mousemove',function(){e.fill('blue')});f.on('mouseout',function(){e.fill('black')});b.lastOptionHeight=e.height();c.optionsGroup.add(f);f.moveToTop();b.currentY+=e.height()}function addSelector(a){const b={currentOptionElements:undefined,currentY:transformToResultY(a.visibleElement.geometry.rect.leftTopPosition.absolutePosition.y),lastOptionHeight:0,width:scaleToResultX(a.visibleElement.geometry.rect.width),correctState:{hasCorrect:false}};a.selector.options.forEach(e=>{if(e.isCorrect==="1"){solvingParams.allSolvingElements++;b.correctState.hasCorrect=true}});const c=getStyles(a.visibleElement.style,interactivePicture.style.selector,defaultKonvaStyles);const d=createSelectorKonvaElements(a,b,c);for(let e of a.selector.options){addSelectorOption(e,b,d)};b.currentY-=b.lastOptionHeight;d.optionsRect.height(b.currentY- d.mainGroup.getY());addSelectorEvents(d,a,c,b);d.selector.add(d.optionsGroup);interactiveLayer.add(d.selector)}function addControls(a){if(a){a.forEach(b=>{switch(b.type){case 'Selector':addSelector(b);break;case 'Input':addInput(b);break;case 'Button':addButton(b);break}})}}function createGapPuzzleKonvaElements(a){const b=placeNewObjectToBottomLeft(scaleToResultX(a.visibleElement.geometry.rect.width),scaleToResultY(a.visibleElement.geometry.rect.height));const c=new Konva.Group({x:b[0],y:b[1],draggable:true,startScale:1.0});const d=createKonvaRect(a.gapPuzzle.gap);const {x:e,y:f}=a.gapPuzzle.gap.geometry.rect.leftTopPosition.absolutePosition;const g={x:transformToResultX(e),y:transformToResultY(f)};d.position({x:transformToResultX(e),y:transformToResultY(f)});if(a.visibleElement.type==="BackgroundDrag"){createKonvaBluredBGCut(d,g,interactiveLayer.toDataURL(),gapLayer,true,20)};gapLayer.add(d);const h=createKonvaRect(a.visibleElement,interactivePicture.style.drag);c.add(h);let i;if(a.visibleElement.picture){createKonvaPicture(h,a.visibleElement.picture,c)};if(a.visibleElement.type==="BackgroundDrag"){createKonvaBluredBGCut(h,g,interactiveLayer.toDataURL(),c,false,0)}else{i=createKonvaText(h,a.visibleElement.text,interactivePicture.style.defaultText);c.add(i)};return {gapPuzzle:c,text:i,rect:h}}function addGapPuzzleEvents(a,b,c,d,e,f){let g;const h=getStyles(c.visibleElement.style,interactivePicture.style.drag,defaultKonvaStyles);let i=null;const j=()=>{a.gapPuzzle.moveToTop();if(solvingState===SolvingState.BEFORE_SOLVING_START){solvingState=SolvingState.WHILE_SOLVING;document.dispatchEvent(new CustomEvent('solving-state'))};if(i){i.pause()};a.gapPuzzle.setAttrs({scale:{x:a.gapPuzzle.getAttr('startScale')*1.2,y:a.gapPuzzle.getAttr('startScale')*1.2}})};a.gapPuzzle.on('dragstart',j);const k=()=>{if(g===ECorrectState.Correct){setStyleOnEvent(a.rect,"Rect",h.correctSelected)}else if(g===ECorrectState.Incorrect){setStyleOnEvent(a.rect,"Rect",h.wrongSelected)}else{setStyleOnEvent(a.rect,"Rect",h.onHover)}};const l=()=>{if(g===ECorrectState.Correct){setStyleOnEvent(a.rect,"Rect",h.correctSelected)}else if(g===ECorrectState.Incorrect){setStyleOnEvent(a.rect,"Rect",h.wrongSelected)}else{setStyleOnEvent(a.rect,"Rect",h.usual)}};a.gapPuzzle.on('mousemove',k);a.gapPuzzle.on('mouseout',l);const m=()=>{const p=a.gapPuzzle.absolutePosition();const q={x:p.x+ a.rect.width()/2,y:p.y+ a.rect.height()/2};b.forEach((r,s)=>{const t=transformToResultX(r.gapPuzzle.gap.geometry.rect.leftTopPosition.absolutePosition.x);const u=transformToResultY(r.gapPuzzle.gap.geometry.rect.leftTopPosition.absolutePosition.y);const v=transformToResultX(r.gapPuzzle.gap.geometry.rect.leftTopPosition.absolutePosition.x+ r.gapPuzzle.gap.geometry.rect.width);const w=transformToResultY(r.gapPuzzle.gap.geometry.rect.leftTopPosition.absolutePosition.y+ r.gapPuzzle.gap.geometry.rect.height);if(t<=q.x&&q.x<=v&&u<=q.y&&q.y<=w&&d[s]===-1){p.x=(t+ v- a.rect.width())*0.5;p.y=(u+ w- a.rect.height())*0.5;a.gapPuzzle.absolutePosition(p);d[s]=1;e[f]=s}});a.gapPuzzle.moveToTop();i=new Konva.Tween({node:a.gapPuzzle,duration:0.5,easing:Konva.Easings.ElasticEaseOut,scaleX:a.gapPuzzle.getAttr('startScale'),scaleY:a.gapPuzzle.getAttr('startScale')});i.play()};a.gapPuzzle.on('dragend',m);a.gapPuzzle.on('mouseenter',function(){window.document.body.style.cursor='pointer'});a.gapPuzzle.on('mouseleave',function(){window.document.body.style.cursor='default'});const n=()=>{const p=a.gapPuzzle.absolutePosition();if(p.x>windowParams.backgroundEndX- a.rect.width()){p.x=windowParams.backgroundEndX- a.rect.width();a.gapPuzzle.absolutePosition(p)}else if(p.x<windowParams.backgroundStartX){p.x=windowParams.backgroundStartX;a.gapPuzzle.absolutePosition(p)};if(p.y<0){p.y=0;a.gapPuzzle.absolutePosition(p)}else if(p.y>windowParams.currentFreeSpaceY){p.y=windowParams.currentFreeSpaceY;a.gapPuzzle.absolutePosition(p)};const q={x:p.x+ a.rect.width()/2,y:p.y+ a.rect.height()/2};b.forEach((r,s)=>{const t=transformToResultX(r.gapPuzzle.gap.geometry.rect.leftTopPosition.absolutePosition.x);const u=transformToResultY(r.gapPuzzle.gap.geometry.rect.leftTopPosition.absolutePosition.y);const v=transformToResultX(r.gapPuzzle.gap.geometry.rect.leftTopPosition.absolutePosition.x+ r.gapPuzzle.gap.geometry.rect.width);const w=transformToResultY(r.gapPuzzle.gap.geometry.rect.leftTopPosition.absolutePosition.y+ r.gapPuzzle.gap.geometry.rect.height);if(t<=q.x&&q.x<=v&&u<=q.y&&q.y<=w){if(d[s]===-1){p.x=(t+ v- a.rect.width())*0.5;p.y=(u+ w- a.rect.height())*0.5;a.gapPuzzle.absolutePosition(p)}}else if(d[s]===1&&e[f]===s){d[s]=-1;e[f]=-1}});a.gapPuzzle.moveToTop()};a.gapPuzzle.on('dragmove',n);const o=()=>{if(checkStageCondition(c.visibleElement.showCondition)){if(checkGapPuzzle(a,c)){if(g!==ECorrectState.Correct){solvingParams.currentSolved++};setStyleOnEvent(a.rect,"Rect",h.correctSelected);g=ECorrectState.Correct}else{if(g===ECorrectState.Correct){solvingParams.currentSolved--};setStyleOnEvent(a.rect,"Rect",h.wrongSelected);g=ECorrectState.Incorrect}}};document.addEventListener('check-solving',o);document.addEventListener("solving-state",()=>{handleShowCondition(c.visibleElement.showCondition,a.gapPuzzle)})}function addGapPuzzle(a,b,c,d,e){const f=createGapPuzzleKonvaElements(a);addGapPuzzleEvents(f,b,a,c,d,e);puzzleLayer.add(f.gapPuzzle);if(a.hint.geometry&&a.hint.text.simpleText){addHint(a.hint,f.gapPuzzle,puzzleLayer)}}function addGapPuzzles(a){if(a){let b=[];b=Array(a.length).fill(-1);let c=[];c=Array(a.length).fill(-1);solvingParams.allSolvingElements+=a.length;a.forEach((d,e)=>{addGapPuzzle(d,a,b,c,e)})}}function renderFigure(a,b){const c=getGeometry(a);const d=c.leftTopPosition||c.centerPosition;const e=a.visibleElement.text;const f=a.visibleElement.picture;const g=new Konva.Group({x:transformToResultX(d.absolutePosition.x),y:transformToResultY(d.absolutePosition.y)});if(f){g.add(b);createKonvaPicture(b,f,g)}else if(e){g.add(b,createKonvaText(b,e))}else{g.add(b)};if(a.hint.geometry&&a.hint.text.simpleText){addHint(a.hint,g)};document.addEventListener("solving-state",()=>{handleShowCondition(a.visibleElement.showCondition,g)});let h;if(a.visibleElement.geometry.rect){h="Rect"};const i=getStyles(a.visibleElement.style,interactivePicture.style.staticFigure,defaultKonvaStyles);g.on('mousemove',()=>{setStyleOnEvent(b,h,i.onHover)});g.on('mouseout',()=>{setStyleOnEvent(b,h,i.usual)});return g}function addFigure(a,b){const c=getGeometry(a);const d=interactivePicture.style.staticFigure;switch(c.type){case "Rect":const e=renderFigure(a,createKonvaRect(a.visibleElement,d));b.add(e);return e;case "Circle":const f=renderFigure(a,createKonvaCircle(a,d));b.add(f);return f;default:throw new Error("incorrect geometry type")}}function addCurve(a){const b=createKonvaCurve(a);document.addEventListener("solving-state",()=>{handleShowCondition(a.visibleElement.showCondition,b)});interactiveLayer.add(b);return b}function addFiguresAndLines(a){if(a){a.forEach(b=>{switch(b.type){case "Figure":addFigure(b,interactiveLayer);break;case "Connection":addCurve(b,interactiveLayer);break}})}}function addHint(a,b,c){const d=new Konva.Group({visible:false,opacity:0.85});if(c===undefined){c=interactiveLayer};const e=createKonvaRect(a,interactivePicture.style.hint);const f=createKonvaText(e,a.text,interactivePicture.style.hintText);d.add(e);d.add(f);c.add(d);const g=()=>{if(solvingState===SolvingState.BEFORE_SOLVING_START){solvingState=SolvingState.WHILE_SOLVING;document.dispatchEvent(new CustomEvent("solving-state"))};if(handleShowCondition(a.showCondition,d)){if(a.geometry&&a.geometry.rect.leftTopPosition.relativeToMousePosition&&a.geometry.rect.leftTopPosition.relativeToMousePosition.x&&a.geometry.rect.leftTopPosition.relativeToMousePosition.y){let h=scaleToResultX(a.geometry.rect.leftTopPosition.relativeToMousePosition.x);let i=scaleToResultY(a.geometry.rect.leftTopPosition.relativeToMousePosition.y);const j=stage.getPointerPosition();let k=j.x+ h;let l=j.y+ i;if(k>windowParams.windowWidth/2){k-=f.width()+ 2*h};if(l+ f.height()>windowParams.windowHeight){l-=f.height()+ 2*i};d.position({x:k,y:l})}else if(a.geometry&&a.geometry.rect.leftTopPosition.absolutePosition&&a.geometry.rect.leftTopPosition.absolutePosition.x&&a.geometry.rect.leftTopPosition.absolutePosition.y){let h=a.geometry.rect.leftTopPosition.absolutePosition.x;let i=a.geometry.rect.leftTopPosition.absolutePosition.y;d.position({x:transformToResultX(h),y:transformToResultY(i)})}else{d.position({x:(windowParams.windowWidth- e.width())*0.5,y:windowParams.backgroundImageWidth*0.03})}}};b.on('mousemove touchstart dragmove',g);b.on('mouseout touchend',function(){d.hide()})}function addInput(a){a.visibleElement.text.simpleText=undefined;const b=addFigure(a,interactiveLayer);const c=b.getChildren()[0];let d;const e=a.input.placeholderText;const f=a.visibleElement.text.style;const g=getStyles(a.input.style,a.visibleElement.style,defaultKonvaStyles);const h=a.input.type;if(a.hint.geometry&&a.hint.text.simpleText){addHint(a.hint,b)};solvingParams.allSolvingElements++;const i=a.input.correctValue;let j=false;const k=()=>{if(d==="correctSelected"){setStyleOnEvent(c,"Rect",g.correctSelected)}else if(d==="incorrectSelected"){setStyleOnEvent(c,"Rect",g.wrongSelected)}else if(d==="correctUnselected"){setStyleOnEvent(c,"Rect",g.correctUnselected)}else if(d==="incorrectUnselected"){setStyleOnEvent(c,"Rect",g.wrongUnselected)}else{setStyleOnEvent(c,"Rect",g.onHover)}};b.on("mousemove",k);const l=()=>{if(d==="correctSelected"){setStyleOnEvent(c,"Rect",g.correctSelected)}else if(d==="incorrectSelected"){setStyleOnEvent(c,"Rect",g.wrongSelected)}else if(d==="correctUnselected"){setStyleOnEvent(c,"Rect",g.correctUnselected)}else if(d==="incorrectUnselected"){setStyleOnEvent(c,"Rect",g.wrongUnselected)}else{setStyleOnEvent(c,"Rect",g.usual)}};b.on("mouseout",l);const m=createKonvaText(c,{simpleText:e,style:f});b.on('click tap',()=>{if(!m.isVisible()){return};m.hide();j=true;if(m.text()===e){m.text("")};const p=m.absolutePosition();const q={x:stage.container().offsetLeft+ p.x,y:stage.container().offsetTop+ p.y};const r=document.createElement('input');document.body.appendChild(r);r.value=m.text();r.type=h==="AnyPlainText"?"text":"number";r.style.position='absolute';r.style.left=q.x+ 'px';r.style.width=m.width()- m.padding()*2+ 'px';r.style.height=m.height()+ 'px';r.style.fontSize=m.fontSize()+ 'px';r.style.border='none';r.style.padding="0px "+ m.padding()+ 'px';r.style.margin='0px';r.style.overflow='hidden';r.style.background='none';r.style.outline='none';r.style.resize='none';r.style.lineHeight=m.lineHeight();r.style.fontFamily=m.fontFamily();r.style.textAlign=m.align();r.style.color=m.fill();r.maxLength=a.input.maxLength;r.style.height='auto';r.style.height=r.scrollHeight+ 3+ 'px';if(f.verticalAlign==="middle"){r.style.top=q.y+ c.height()/2- r.clientHeight/2+ 'px'}else if(f.verticalAlign==="bottom"){r.style.top=q.y+ c.height()- r.clientHeight- m.padding()+ 'px'}else{r.style.top=q.y+ m.padding()+ 'px'};r.focus();r.onchange=s=>{if(!s.target.value||s.target.value.trim()===""){j=false}else{m.text(s.target.value);j=true}};function n(){if(r.parentNode.childElementCount>0){r.parentNode.removeChild(r);window.removeEventListener('click',o);m.show()}}function o(s){if(s.target===r||s.target===b){return};if(!r.value||r.value.trim()===""){m.text(e)};n();document.removeEventListener('click',o)}setTimeout(()=>{document.addEventListener('click',o)})});document.addEventListener("check-solving",function(){let n=m.text().trim();if(i.toLowerCase()===n.toLowerCase()){setStyleOnEvent(c,"Rect",g.correctSelected);if(d!=="correctSelected"){solvingParams.currentSolved++};d="correctSelected"};if(i.toLowerCase()!==n.toLowerCase()){setStyleOnEvent(c,"Rect",g.wrongSelected);if(d==="correctSelected"){solvingParams.currentSolved--};d="incorrectSelected"}});document.addEventListener("solving-state",()=>{handleShowCondition(a.visibleElement.showCondition,b)});b.add(m)}function addButton(a){const b=getStyles(a.visibleElement.style,interactivePicture.style.button,defaultKonvaStyles);const c=getGeometry(a);const d=c.leftTopPosition||c.centerPosition;let e;const f=(g,h)=>{const i=new Konva.Group({x:transformToResultX(h.absolutePosition.x),y:transformToResultY(h.absolutePosition.y),id:a.identifier.code});let j=false;let k=false;i.add(g);if(a.visibleElement.text){const o=createKonvaText(g,a.visibleElement.text,defaultKonvaStyles.textFrame);i.add(o)};if(a.hint.geometry&&a.hint.text.simpleText){addHint(a.hint,i)};if(b.onHover.mouseCursor==="pointer"){i.on('mouseenter',()=>window.document.body.style.cursor="pointer");i.on('mouseleave',()=>window.document.body.style.cursor="default")};i.on('click tap',()=>{if(!k){k=true};j=!j;if(j){setStyleOnEvent(g,"Rect",b.onSelect)}else{setStyleOnEvent(g,"Rect",b.usual)}});if(a.button.correctState){solvingParams.allSolvingElements++};const l=()=>{if(e===ECorrectState.Correct&&!k){setStyleOnEvent(g,"Rect",b.correctSelected)}else if(e===ECorrectState.Incorrect&&!k){setStyleOnEvent(g,"Rect",b.wrongSelected)}else if(!j){setStyleOnEvent(g,"Rect",b.onHover)}};i.on('mousemove',l);const m=()=>{if(e===ECorrectState.Correct&&!k){setStyleOnEvent(g,"Rect",b.correctSelected)}else if(e===ECorrectState.Incorrect&&!k){setStyleOnEvent(g,"Rect",b.wrongSelected)}else if(!j){setStyleOnEvent(g,"Rect",b.usual)}};i.on('mouseout',m);const n=()=>{if(a.button.correctState){k=false;if(j&&a.button.correctState==="selected"||!j&&a.button.correctState==="unselected"){setStyleOnEvent(g,"Rect",b.correctSelected);if(e!==ECorrectState.Correct){solvingParams.currentSolved++};e=ECorrectState.Correct}else{if(e===ECorrectState.Correct){solvingParams.currentSolved--};setStyleOnEvent(g,"Rect",b.wrongSelected);e=ECorrectState.Incorrect}}};document.addEventListener('check-solving',n);document.addEventListener("solving-state",()=>{handleShowCondition(a.visibleElement.showCondition,i)});interactiveLayer.add(i)};switch(c.type){case "Rect":f(createKonvaRect(a.visibleElement,interactivePicture.style.button),d);break;case "Circle":f(createKonvaCircle(a,interactivePicture.style.button),d);break;default:throw new Error("incorrect geometry type in button")}}function addFrames(a){if(a){a.forEach(b=>{addFigure(b,interactiveLayer)})}}function createControlButton(a,b,c,d,e,f){const g=new Konva.Group({x:d.x,y:d.y});const h={geometry:{rect:{type:"Rect",width:e,height:f}}};const i={simpleText:a,style:b};const j=createKonvaRect(h,c);const k=createKonvaText(j,i,b);g.on('mouseenter',()=>window.document.body.style.cursor="pointer");g.on('mouseleave',()=>window.document.body.style.cursor="default");const l=()=>{j.opacity(0.85)};g.on('mousemove',l);const m=()=>{j.opacity(1)};g.on('mouseout',m);g.add(j,k);return g}function renderCheckButton(a,b,c,d){const e={simpleText:"CHECK",rectStyle:interactivePicture.style.checkButton||{usual:{cornerRadius:5,fillColor:"#181818"}},textStyle:interactivePicture.style.checkButtonText||{fontFamily:"Arial",fontSize:14,align:"center",textColor:"#fff",padding:15,fontStyle:"700"},position:{x:a,y:b}};const f=createControlButton(e.simpleText,e.textStyle,e.rectStyle,e.position,c,d);f.on("click tap",()=>{document.dispatchEvent(checkEvent);if(solvingState===SolvingState.WHILE_SOLVING||solvingState===SolvingState.BEFORE_SOLVING_START){solvingState=SolvingState.AFTER_FIRST_VERIFICATION;document.dispatchEvent(new CustomEvent('solving-state'))};console.log(solvingParams);if(solvingParams.allSolvingElements===solvingParams.currentSolved){document.getElementById('popup').classList.remove('popup_hide')}});interactiveLayer.add(f)}function renderRestartButton(a,b,c,d){const e={simpleText:"RESTART",rectStyle:interactivePicture.style.restartButton||{usual:{cornerRadius:5,fillColor:"#FEFCFD",strokeWidth:2,strokeColor:'#181818'}},textStyle:interactivePicture.style.restartButtonText||{fontFamily:"Arial",fontSize:14,align:"center",textColor:"#181818",padding:15,fontStyle:"700"},position:{x:a,y:b}};const f=createControlButton(e.simpleText,e.textStyle,e.rectStyle,e.position,c,d);f.on("click tap",()=>window.location.reload());interactiveLayer.add(f)}function addControlButtons(){const a=100;const b=40;const {hasRestartButton:c,checkPatternType:d}=interactivePicture;if(c!=="1"&&d!=="CheckButton"){return null};const [e,f]=placeNewObjectToBottomCenterNewLine(2*a+ windowParams.widthPadding,b);if(d==="CheckButton"){renderCheckButton(e,f+ windowParams.heightPadding,a/scaleParams.resultDivOriginalScaleX,b/scaleParams.resultDivOriginalScaleY)};if(c==="1"){renderRestartButton(e+ a+ windowParams.widthPadding,f+ windowParams.heightPadding,a/scaleParams.resultDivOriginalScaleX,b/scaleParams.resultDivOriginalScaleY)}}function fillParams(a,b){scaleParams.resultDivOriginalScaleX=windowParams.backgroundImageWidth/a;scaleParams.resultDivOriginalScaleY=windowParams.backgroundImageHeight/b;var c=Math.min(scaleParams.resultDivOriginalScaleX,scaleParams.resultDivOriginalScaleY);scaleParams.resultDivOriginalScaleX=c;scaleParams.resultDivOriginalScaleY=c;scaleParams.resultMinusOriginalScaledShiftX=(windowParams.windowWidth- a*c)*0.5;scaleParams.resultMinusOriginalScaledShiftY=10.0;windowParams.backgroundImageWidth=scaleToResultX(a);windowParams.backgroundImageHeight=scaleToResultY(b);windowParams.currentFreeSpaceX=transformToResultX(0);windowParams.backgroundStartX=windowParams.currentFreeSpaceX;windowParams.backgroundEndX=windowParams.backgroundStartX+ windowParams.backgroundImageWidth;windowParams.currentFreeSpaceY=transformToResultY(0)}function buildElements(){windowParams.currentFreeSpaceY=windowParams.currentFreeSpaceY+ windowParams.backgroundImageHeight+ windowParams.heightPadding;windowParams.newLineSpaceY=windowParams.currentFreeSpaceY;console.log(interactivePicture);checkEvent=new CustomEvent("check-solving",{bubbles:true});addFrames(interactivePicture.frames);addFiguresAndLines(interactivePicture.figuresAndLines);addControls(interactivePicture.controls);addGapPuzzles(interactivePicture.gapPuzzles);addControlButtons();document.dispatchEvent(new CustomEvent("solving-state"))}function buildBackgroundPicture(){var a=new Image();a.src=interactivePicture.background.picture.base64;a.onload=function(){var b=new Konva.Image({x:windowParams.currentFreeSpaceX,y:windowParams.currentFreeSpaceY,width:windowParams.backgroundImageWidth,height:windowParams.backgroundImageHeight,image:a});if(interactivePicture.style.background){const c=interactivePicture.style.background.usual;b.stroke(c.strokeColor);b.strokeWidth(c.strokeWidth);b.dash(c.dash);b.opacity(c.opacity)};interactiveLayer.add(b);buildElements()}}function addBackground(a,b,c){const d=new Konva.Rect({x:transformToResultX(0),y:transformToResultY(0),width:b,height:c,fill:a.fillColor,stroke:a.strokeColor,strokeWidth:a.strokeWidth,dash:a.dash,opacity:a.opacity});interactiveLayer.add(d)}function buildInteractivePicture(){fillParams(interactivePicture.background.width,interactivePicture.background.height);if(interactivePicture.background.picture){buildBackgroundPicture()}else{if(interactivePicture.style.background){addBackground(interactivePicture.style.background.usual,scaleToResultX(interactivePicture.background.width),scaleToResultY(interactivePicture.background.height))};buildElements()}}const SolvingState={BEFORE_SOLVING_START:1,WHILE_SOLVING:2,AFTER_FIRST_VERIFICATION:3,AFTER_FINAL_VERIFICATION:4};var solvingState=SolvingState.BEFORE_SOLVING_START;var checkAttemptsCount=0;var stage=new Konva.Stage({container:'konva_interactive_container',width:windowParams.windowWidth,height:windowParams.windowHeight});var interactiveLayer=new Konva.Layer();stage.add(interactiveLayer);var gapLayer=new Konva.Layer();stage.add(gapLayer);var puzzleLayer=new Konva.Layer();stage.add(puzzleLayer);buildInteractivePicture()</script></body></html>